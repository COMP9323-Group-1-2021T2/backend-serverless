service: comp9323

variablesResolutionMode: 20210326

plugins:
  - serverless-plugin-typescript
  - serverless-prune-plugin

provider:
  name: aws
  runtime: nodejs12.x
  profile: comp9323
  memorySize: 128
  region: ap-southeast-2 # Sydney
  stage: ${opt:stage, 'staging'}
  lambdaHashingVersion: "20201221"
  timeout: 30
  vpc: ${self:custom.vpc}
  apiGateway:
    shouldStartNameWithService: true
  environment:
    DB_CONN_URL: ${self:custom.env.DB_CONN_URL}

functions:
  UpMigration:
    handler: src/migrations/UpMigration.handler

  SeedData:
    handler: src/migrations/SeedData.handler

  GetCategories:
    handler: src/http/GetCategories.handler
    events:
      - http:
          path: /categories
          method: get
          cors: true

  GetCategoryInfo:
    handler: src/http/GetCategoryInfo.handler
    events:
      - http:
          path: /{categoryId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                categoryId: true

  GetCategoryArticles:
    handler: src/http/GetCategoryArticles.handler
    events:
      - http:
          path: /{categoryId}/articles
          method: get
          cors: true
          request:
            parameters:
              paths:
                categoryId: true

  # GetCategoryVideos:
  #   handler: src/http/GetCategoryVideos.handler
  #   events:
  #     - http:
  #         path: /{parentId}/{subId}/videos
  #         method: get
  #         cors: true
  #         request:
  #           parameters:
  #             paths:
  #               parentId: true
  #               subId: true

custom:
  env:
    # DB_CONN_URL: ${ssm:/comp9323/${self:provider.stage}/DB_CONN_URL}
    DB_CONN_URL: ${ssm:/comp9323/staging/DB_CONN_URL}
  vpc:
    # securityGroupIds: ${ssm:/comp9323/${self:provider.stage}/DEFAULT_SECURITY_GROUP}
    # subnetIds: ${ssm:/comp9323/${self:provider.stage}/PRIVATE_SUBNET_IDS}
    securityGroupIds: ${ssm:/comp9323/staging/DEFAULT_SECURITY_GROUP}
    subnetIds: ${ssm:/comp9323/staging/PRIVATE_SUBNET_IDS}

  prune:
    automatic: true
    number: 2
